---
- hosts: all
  become: yes
  become_user: gregory
  gather_facts: True
  tasks:

  ##################
  # Enable UFW #
  ##################
  - name: Install ufw firewall
    community.general.ufw:
      state: enabled
      policy: allow

  ######################
  # Enable logging UFW #
  ######################
  - name: Set logging
    community.general.ufw:
      logging: 'on'
  
  ##################
  # open port 80 #
  ##################
  - name: Allow all access to port 9090
    become: yes
    become_user: root
    ufw:
      rule: allow
      port: '80'
      proto: tcp

  ##################
  # open port 443 #
  ##################
  - name: Allow all access to port 9100
    become: yes
    become_user: root
    ufw:
      rule: allow
      port: '443'
      proto: tcp

  ##################
  # open port 853 #
  ##################
  - name: Allow all access to port 8080
    become: yes
    become_user: root
    ufw:
      rule: allow
      port: '853'
      proto: tcp
  
  ###############################
  # Creating docker network web #
  ###############################
  - name: Create web network
    docker_network:
      name: web

  ######################################
  # Creating docker network web-secure #
  ######################################
  - name: Create web-secure network
    docker_network:
      name: web-secure

  #########################################
  # Creating a temp directory on the host #
  #########################################
  - name: Create a temp directory if it does not exist
    ansible.builtin.file:
      path: ~/temp/traefik/
      state: directory
      mode: '0777'

  ######################################
  # Checkout Git Repo for latest code #
  ######################################
  - name: Checkout Git repo in temp directory
    ansible.builtin.git:
      repo: 'https://github.com/gregoryca/traefik.git'
      dest: ~/temp/traefik/

  ########################################
  # Creating a srv directory on the host #
  ########################################  
  - name: Create the srv directory if it does not exist
    ansible.builtin.file:
      path: ~/srv/
      state: directory
      mode: '0777'

  ######################################################
  # Creating a the configuration directory on the host #
  ######################################################
  # - name: Create the configurations directory if it does not exist
  #   ansible.builtin.file:
  #     path: ~/srv/traefik/configurations/
  #     state: directory
  #     mode: '0777'

  #########################
  # Copy the compose file #
  #########################
  - name: copy git repo to remote server
    copy:
      src: ~/temp/traefik
      dest: ~/srv/
      remote_src: yes

  ###############################
  # Copy the static config file #
  ###############################
  # - name: copy static traefik config file to remote server
  #   copy:
  #     src: /temp/traefik/configurations/traefik.yml
  #     dest: ~/srv/traefik/configurations/traefik.yml
  #     remote_src: yes
  #   loop:
  #   - traefik.yml

  ################################
  # Copy the dynamic config file #
  ################################
  # - name: copy dynamic traefik config file to remote server
  #   copy:
  #     src: /temp/traefik/configurations/dynamic.yml
  #     dest: ~/srv/traefik/configurations/dynamic.yml
  #     remote_src: yes
  #   loop:
  #   - dynamic.yml

  #######################
  # Deploy compose file #
  #######################
  # - name: deploy Docker Compose stack on remote server
  #   docker_compose:
  #     project_src: ~/srv/traefik/
  #     files:
  #     - docker-compose.yml
  #     recreate: always

  #########################################
  # Clean up temp folder after deployment #
  #########################################
  - name: Delete content & directory
    file:
      state: absent
      path: ~/temp/